 <!DOCTYPE html>  <html> <head>   <title>snockets.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="../docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>     <!--          -->     <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               snockets.coffee             </h1>             <div class="filepath">src/</div>                                   </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><a href="http://github.com/TrevorBurnham/snockets">snockets</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DepGraph = </span><span class="nx">require</span> <span class="s1">&#39;dep-graph&#39;</span>

<span class="nv">CoffeeScript = </span><span class="nx">require</span> <span class="s1">&#39;coffee-script&#39;</span>
<span class="nv">fs           = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nv">path         = </span><span class="nx">require</span> <span class="s1">&#39;path&#39;</span>
<span class="nv">uglify       = </span><span class="nx">require</span> <span class="s1">&#39;uglify-js&#39;</span>
<span class="nv">_            = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span>
<span class="nv">exists       = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="o">or</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span>

<span class="nv">debug = </span><span class="kc">false</span>
<span class="k">if</span> <span class="nx">debug</span>
  <span class="nv">logger =</span>
    <span class="nv">debug: </span><span class="nf">(args...) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">args</span><span class="p">...</span>
<span class="k">else</span>
  <span class="nv">logger =</span>
    <span class="nv">debug: </span><span class="o">-&gt;</span>

<span class="nv">module.exports = </span><span class="k">class</span> <span class="nx">Snockets</span>
  <span class="nv">constructor: </span><span class="nf">(@options = {}) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">src</span>
      <span class="vi">@options.src = </span><span class="p">[</span><span class="nx">@options</span><span class="p">.</span><span class="nx">src</span> <span class="o">or</span> <span class="s1">&#39;.&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>By default, Snockets uses only async file methods. You can pass the
option async: false to either of its methods if you want it to be
synchronous instead. In synchronous mode, you can use either callbacks or
return values</p>

<p><code>js = snockets.getConcatenation 'dir/foo.coffee', async: false</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@options</span><span class="p">.</span><span class="nx">async</span> <span class="o">?=</span> <span class="kc">true</span>

    <span class="vi">@cache = </span><span class="p">{}</span>
    <span class="vi">@concatCache = </span><span class="p">{}</span>
    <span class="vi">@depGraph = </span><span class="k">new</span> <span class="nx">DepGraph</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Public methods</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Scan a file to update the dependency graph <code>depGraph</code></p>

<p><code>snockets.scan 'dir/foo.coffee', (err, depGraph) -&gt; ...</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">scan: </span><span class="nf">(filePath, flags, callback) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">callback = </span><span class="nx">flags</span><span class="p">;</span> <span class="nv">flags = </span><span class="p">{}</span>
    <span class="nx">flags</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="nx">flags</span><span class="p">.</span><span class="nx">async</span> <span class="o">?=</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">async</span>

    <span class="nx">@updateDirectives</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">graphChanged</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="k">if</span> <span class="nx">callback</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">else</span> <span class="k">throw</span> <span class="nx">err</span>
      <span class="nx">callback</span><span class="o">?</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">@depGraph</span><span class="p">,</span> <span class="nx">graphChanged</span>
      <span class="nx">@depGraph</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Get a list of compiled JavaScripts corresponding to the dependency
chain (starting from the first required file to the requested file)</p>

<p><code>snockets.getCompiledChain 'dir/foo.coffee', (err, jsList) -&gt; ...</code></p>

<p>Returns an Array of objects in the format
`[{filename: "dependency1.js", js: "// code"}, ...]</p>

<p>Note that those JavaScript files are not actually created by
<code>getCompiledChain</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getCompiledChain: </span><span class="nf">(filePath, flags, callback) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">callback = </span><span class="nx">flags</span><span class="p">;</span> <span class="nv">flags = </span><span class="p">{}</span>
    <span class="nx">flags</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="nx">flags</span><span class="p">.</span><span class="nx">async</span> <span class="o">?=</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">async</span>

    <span class="nx">@updateDirectives</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">graphChanged</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="k">if</span> <span class="nx">callback</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">else</span> <span class="k">throw</span> <span class="nx">err</span>
      <span class="k">try</span>
        <span class="nv">chain = </span><span class="nx">@depGraph</span><span class="p">.</span><span class="nx">getChain</span> <span class="nx">filePath</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="k">if</span> <span class="nx">callback</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">e</span> <span class="k">else</span> <span class="k">throw</span> <span class="nx">e</span>

      <span class="nv">compiledChain = </span><span class="k">for</span> <span class="nx">link</span> <span class="k">in</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">filePath</span>
        <span class="nv">o = </span><span class="p">{}</span>
        <span class="k">if</span> <span class="nx">@compileFile</span> <span class="nx">link</span>
          <span class="nv">o.filename = </span><span class="nx">stripExt</span><span class="p">(</span><span class="nx">link</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.js&#39;</span>
        <span class="k">else</span>
          <span class="nv">o.filename = </span><span class="nx">link</span>
        <span class="nv">o.js = </span><span class="nx">@cache</span><span class="p">[</span><span class="nx">link</span><span class="p">].</span><span class="nx">js</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
        <span class="nx">o</span>

      <span class="nx">callback</span><span class="o">?</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">compiledChain</span><span class="p">,</span> <span class="nx">graphChanged</span>
      <span class="nx">compiledChain</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Return a single compiled, concatenated file (optionally run through UglifyJS
if the minify option is passed in)</p>

<p><code>snockets.getConcatenation 'dir/foo.coffee', minify: true, (err, js) -&gt; ...</code></p>

<p>Note that you don't need to scan before or after running <code>getCompiledChain</code>
or # <code>getConcatenation</code>; they update the dependency graph the same way that
scan does.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getConcatenation: </span><span class="nf">(filePath, flags, callback) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">flags</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
      <span class="nv">callback = </span><span class="nx">flags</span><span class="p">;</span> <span class="nv">flags = </span><span class="p">{}</span>
    <span class="nx">flags</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="nx">flags</span><span class="p">.</span><span class="nx">async</span> <span class="o">?=</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">async</span>
    <span class="nv">concatenationChanged = </span><span class="kc">true</span>

    <span class="nx">@updateDirectives</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">graphChanged</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="k">if</span> <span class="nx">callback</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">else</span> <span class="k">throw</span> <span class="nx">err</span>
      <span class="k">try</span>
        <span class="k">if</span> <span class="nx">@concatCache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">data</span>
          <span class="nv">concatenation = </span><span class="nx">@concatCache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
          <span class="k">if</span> <span class="o">!</span><span class="nx">flags</span><span class="p">.</span><span class="nx">minify</span> <span class="k">then</span> <span class="nv">concatenationChanged = </span><span class="kc">false</span>
        <span class="k">else</span>
          <span class="nv">chain = </span><span class="nx">@depGraph</span><span class="p">.</span><span class="nx">getChain</span> <span class="nx">filePath</span>
          <span class="nv">concatenation = </span><span class="p">(</span><span class="k">for</span> <span class="nx">link</span> <span class="k">in</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">filePath</span>
            <span class="nx">@compileFile</span> <span class="nx">link</span>
            <span class="nx">@cache</span><span class="p">[</span><span class="nx">link</span><span class="p">].</span><span class="nx">js</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
          <span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;\n&#39;</span>
          <span class="nx">@concatCache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span> <span class="o">=</span> <span class="nv">data: </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">concatenation</span><span class="p">)</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="k">if</span> <span class="nx">callback</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">callback</span> <span class="nx">e</span> <span class="k">else</span> <span class="k">throw</span> <span class="nx">e</span>

      <span class="k">if</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">minify</span>
        <span class="k">if</span> <span class="nx">@concatCache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">minifiedData</span>
          <span class="nv">result = </span><span class="nx">@concatCache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nx">minifiedData</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
          <span class="nv">concatenationChanged = </span><span class="kc">false</span>
        <span class="k">else</span>
          <span class="nv">result = </span><span class="nx">minify</span> <span class="nx">concatenation</span>
          <span class="nx">@concatCache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nv">minifiedData = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">result = </span><span class="nx">concatenation</span>

      <span class="nx">callback</span><span class="o">?</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">concatenationChanged</span>
      <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Internal methods</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Interprets the directives from the given file to update <code>@depGraph</code>.
TODO: We should allow absolute paths by searching from specified
  asset paths similar to sprockets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">updateDirectives: </span><span class="nf">(filePath, flags, excludes..., callback) -&gt;</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">()</span> <span class="k">if</span> <span class="nx">filePath</span> <span class="k">in</span> <span class="nx">excludes</span>
    <span class="nx">excludes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filePath</span>

    <span class="nv">depList = </span><span class="p">[]</span>
    <span class="nv">graphChanged = </span><span class="kc">false</span>
    <span class="nv">q = </span><span class="k">new</span> <span class="nx">HoldingQueue</span>
      <span class="nv">task: </span><span class="p">(</span><span class="nx">depPath</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">getExt</span> <span class="nx">depPath</span>
        <span class="k">if</span> <span class="nx">depPath</span> <span class="o">is</span> <span class="nx">filePath</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Script tries to require itself: #{filePath}&quot;</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span>
        <span class="nx">unless</span> <span class="nx">depPath</span> <span class="k">in</span> <span class="nx">depList</span>
          <span class="nx">depList</span><span class="p">.</span><span class="nx">push</span> <span class="nx">depPath</span>
        <span class="nx">@updateDirectives</span> <span class="nx">depPath</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">excludes</span><span class="p">...,</span> <span class="nf">(err, depChanged) -&gt;</span>
          <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">graphChanged</span> <span class="o">or=</span> <span class="nx">depChanged</span>
          <span class="nx">next</span><span class="p">()</span>
      <span class="nv">onComplete: </span><span class="o">=&gt;</span>
        <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">depList</span> <span class="p">,</span> <span class="nx">@depGraph</span><span class="p">.</span><span class="nx">map</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span>
          <span class="nx">@depGraph</span><span class="p">.</span><span class="nx">map</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">depList</span>
          <span class="nv">graphChanged = </span><span class="kc">true</span>
        <span class="k">if</span> <span class="nx">graphChanged</span>
          <span class="nx">@concatCache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">graphChanged</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>#= require dependency</code> or <code>#= require dep1 dep2</code> or #= require /dep1</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">require = </span><span class="p">(</span><span class="nx">relPath</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;\nProcessing &#39;require #{relPath}&#39;&quot;</span>
      <span class="nx">q</span><span class="p">.</span><span class="nx">waitFor</span> <span class="nv">relName = </span><span class="nx">stripExt</span> <span class="nx">relPath</span>
      <span class="k">if</span> <span class="nx">relName</span><span class="p">.</span><span class="nx">match</span> <span class="nx">EXPLICIT_PATH</span>
        <span class="nv">depPath = </span><span class="nx">relName</span> <span class="o">+</span> <span class="s1">&#39;.js&#39;</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">perform</span> <span class="nx">relName</span><span class="p">,</span> <span class="nx">depPath</span>
      <span class="k">else</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Searching all source roots for:&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The <code>relPath</code> can refer to two things:
1. A file relative its current location.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">depName = </span><span class="nx">@joinPath</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">filePath</span><span class="p">),</span> <span class="nx">relName</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;  #{depName}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <ol>
<li>A file relative to one of the source roots.</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;  #{relPath}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>This method looks for both of them and returns the first it finds.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@findMatchingFile</span> <span class="nx">relPath</span><span class="p">,</span> <span class="nx">depName</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="nf">(err, depPath) -&gt;</span>
          <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">q</span><span class="p">.</span><span class="nx">perform</span> <span class="nx">relName</span><span class="p">,</span> <span class="nx">depPath</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><code>#= require_dir dir</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">requireTree = </span><span class="p">(</span><span class="nx">dirName</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">q</span><span class="p">.</span><span class="nx">waitFor</span> <span class="nx">dirName</span>
      <span class="nx">@readdir</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">dirName</span><span class="p">),</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">items</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">unwaitFor</span> <span class="nx">dirName</span>
        <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span>
          <span class="nv">itemPath = </span><span class="nx">@joinPath</span> <span class="nx">dirName</span><span class="p">,</span> <span class="nx">item</span>
          <span class="k">continue</span> <span class="k">if</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">itemPath</span><span class="p">)</span> <span class="o">is</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
          <span class="nx">q</span><span class="p">.</span><span class="nx">waitFor</span> <span class="nx">itemPath</span>
          <span class="nx">do</span> <span class="p">(</span><span class="nx">itemPath</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@stat</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">itemPath</span><span class="p">),</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span>
              <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
              <span class="k">if</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">isFile</span><span class="p">()</span>
                <span class="nx">q</span><span class="p">.</span><span class="nx">perform</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">itemPath</span>
              <span class="k">else</span>
                <span class="nx">requireTree</span> <span class="nx">itemPath</span>
                <span class="nx">q</span><span class="p">.</span><span class="nx">unwaitFor</span> <span class="nx">itemPath</span>

    <span class="nx">@readFile</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fileChanged</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="nx">fileChanged</span> <span class="k">then</span> <span class="nv">graphChanged = </span><span class="kc">true</span>
      <span class="k">for</span> <span class="nx">directive</span> <span class="k">in</span> <span class="nx">parseDirectives</span><span class="p">(</span><span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="nv">words = </span><span class="nx">directive</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&#39;&quot;]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span> <span class="sr">/\s+/</span>
        <span class="p">[</span><span class="nx">command</span><span class="p">,</span> <span class="nx">relPaths</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">words</span>

        <span class="k">switch</span> <span class="nx">command</span>
          <span class="k">when</span> <span class="s1">&#39;require&#39;</span>
            <span class="nx">require</span> <span class="nx">relPath</span> <span class="k">for</span> <span class="nx">relPath</span> <span class="k">in</span> <span class="nx">relPaths</span>
          <span class="k">when</span> <span class="s1">&#39;require_tree&#39;</span>
            <span class="k">for</span> <span class="nx">relPath</span> <span class="k">in</span> <span class="nx">relPaths</span>
              <span class="nx">requireTree</span> <span class="nx">@joinPath</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">filePath</span><span class="p">),</span> <span class="nx">relPath</span>

      <span class="nx">q</span><span class="p">.</span><span class="nx">finalize</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Searches for a file with the given name (no extension, e.g. <code>'foo/bar'</code>)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">findMatchingFile: </span><span class="nf">(relPath, filename, flags, callback) -&gt;</span>
    <span class="nv">tryFiles = </span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">filePaths</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;\n--- Looking for #{file}&quot;</span>
      <span class="k">for</span> <span class="nx">filePath</span> <span class="k">in</span> <span class="nx">filePaths</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Is &quot;</span> <span class="o">+</span> <span class="nx">stripExt</span><span class="p">(</span><span class="nx">@absPath</span> <span class="nx">filePath</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; == &#39;</span> <span class="o">+</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">stripExt</span><span class="p">(</span><span class="nx">@absPath</span> <span class="nx">filePath</span><span class="p">)</span> <span class="o">is</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
          <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">filePath</span>
          <span class="k">return</span> <span class="kc">true</span>

    <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Trying cache&quot;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">tryFiles</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">@cache</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Search for <code>filename</code> in the same directory as the directive</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@readdir</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">@absPath</span> <span class="nx">filename</span><span class="p">),</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">tryFiles</span> <span class="nx">filename</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span>
        <span class="nx">@joinPath</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">filename</span><span class="p">),</span> <span class="nx">file</span>
      <span class="p">)</span>

      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;</span>
<span class="s2">        \n---Cannot find file in same directory as it was required from.</span>
<span class="s2">        Checking other roots.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Search for 'relPath<code>in a matching source root or sub-directory
of that source root. (</code>@absPath()` will locate the matching source root)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Directory containing file or file itself: &quot;</span> <span class="o">+</span> <span class="nx">@absPath</span> <span class="nx">relPath</span>
      <span class="nx">@readdir</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">@absPath</span> <span class="nx">relPath</span><span class="p">),</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">tryFiles</span> <span class="nx">relPath</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span>
          <span class="nx">@joinPath</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">relPath</span><span class="p">),</span> <span class="nx">file</span>
        <span class="p">)</span>
        <span class="nx">callback</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;File not found: &#39;#{filename}&#39;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Wrapper around fs.readdir or fs.readdirSync, depending on flags.async.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readdir: </span><span class="nf">(dir, flags, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">async</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">dir</span><span class="p">),</span> <span class="nx">callback</span>
    <span class="k">else</span>
      <span class="k">try</span>
        <span class="nv">files = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">files</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="nx">callback</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Wrapper around fs.stat or fs.statSync, depending on flags.async.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stat: </span><span class="nf">(filePath, flags, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">async</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">filePath</span><span class="p">),</span> <span class="nx">callback</span>
    <span class="k">else</span>
      <span class="k">try</span>
        <span class="nv">stats = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">stats</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="nx">callback</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Reads a file's data and timestamp into the cache.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readFile: </span><span class="nf">(filePath, flags, callback) -&gt;</span>
    <span class="nx">@stat</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="nx">timeEq</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">mtime</span><span class="p">,</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span>
        <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span>
      <span class="k">if</span> <span class="nx">flags</span><span class="p">.</span><span class="nx">async</span>
          <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">filePath</span><span class="p">),</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">mtime: </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span><span class="p">,</span> <span class="nx">data</span><span class="p">}</span>
            <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span>
      <span class="k">else</span>
        <span class="k">try</span>
          <span class="nv">data = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
          <span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">mtime: </span><span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span><span class="p">,</span> <span class="nx">data</span><span class="p">}</span>
          <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="nx">callback</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Compile file if neccessary.</p>

<p>Returns false if the file is a JavaScript file and compilation is not
required, or true if the file was compiled.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileFile: </span><span class="nf">(filePath) -&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">ext = </span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span> <span class="nx">filePath</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;.js&#39;</span>
      <span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nv">js = </span><span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nx">data</span>
      <span class="kc">false</span>
    <span class="k">else</span>
      <span class="nv">src = </span><span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
      <span class="nv">js = </span><span class="nx">compilers</span><span class="p">[</span><span class="nx">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">..]].</span><span class="nx">compileSync</span> <span class="nx">@absPath</span><span class="p">(</span><span class="nx">filePath</span><span class="p">),</span> <span class="nx">src</span>
      <span class="nx">@cache</span><span class="p">[</span><span class="nx">filePath</span><span class="p">].</span><span class="nv">js = </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">js</span><span class="p">)</span>
      <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Checks each source root for the existence of this path.</p>

<p>If you have <code>assets/</code> and <code>vendor/</code> roots, it will search each of them
until if finds a match.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">absPath: </span><span class="nf">(relPath) -&gt;</span>
    <span class="k">return</span> <span class="nx">relPath</span> <span class="k">if</span> <span class="nx">relPath</span><span class="p">.</span><span class="nx">match</span> <span class="nx">EXPLICIT_PATH</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>For each search path in <code>@options.src</code>, search for filename.
If found, return the absolute path to the first match.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">result = </span><span class="kc">null</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">any</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">src</span><span class="p">.</span><span class="nx">match</span> <span class="nx">EXPLICIT_PATH</span>
        <span class="nv">candidate = </span><span class="nx">@joinPath</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">relPath</span>
      <span class="k">else</span>
        <span class="nv">candidate = </span><span class="nx">@joinPath</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">relPath</span>
      <span class="nv">result = </span><span class="nx">candidate</span>
      <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">exists</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span>

      <span class="nv">dir = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">exists</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span> <span class="o">and</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">dir</span><span class="p">).</span><span class="nx">isDirectory</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">stripExt</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &gt; &#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span>
          <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">stripExt</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">is</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span>

    <span class="nx">result</span>

  <span class="nv">joinPath: </span><span class="o">-&gt;</span>
    <span class="nv">filePath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Replace backslashes with forward slashes for Windows compatability</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">platform</span> <span class="o">is</span> <span class="s1">&#39;win32&#39;</span>
      <span class="nv">slash = </span><span class="s1">&#39;/&#39;</span> <span class="c1"># / on the same line as the regex breaks ST2 syntax highlight</span>
      <span class="nx">filePath</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\\/g</span><span class="p">,</span> <span class="nx">slash</span>
    <span class="k">else</span>
      <span class="nx">filePath</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h2>Compilers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>When <code>updatingDirectives()</code> is called the key values from this object are
added to the end of each directive when trying to find the matching file.</p>

<p>To add a compiler (for example <code>.js.coffee</code>):</p>

<p>Snockets = require('snockets')
  Snockets.compilers['js.coffee'] =
    match: /.js.coffee$/
    compileSync: Snockets.compilers.coffee</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports.compilers = compilers =</span>
  <span class="nv">coffee:</span>
    <span class="nv">match: </span><span class="sr">/\.js$/</span>
    <span class="nv">compileSync: </span><span class="nf">(sourcePath, source) -&gt;</span>
      <span class="nx">CoffeeScript</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">source</span><span class="p">,</span> <span class="p">{</span><span class="nv">filename: </span><span class="nx">sourcePath</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Regexes</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EXPLICIT_PATH = </span><span class="sr">/^\/|:/</span>

<span class="nv">HEADER = </span><span class="err">///</span>
<span class="p">(</span><span class="o">?:</span>
  <span class="p">(</span><span class="err">\</span><span class="c1">#\#\# .* \#\#\#\n*) |</span>
  <span class="p">(</span><span class="err">// .* \n*) |</span>
  <span class="p">(</span><span class="err">\</span><span class="c1"># .* \n*)</span>
<span class="p">)</span><span class="o">+</span>
<span class="err">///</span>

<span class="nv">DIRECTIVE = </span><span class="err">///</span>
<span class="o">^</span><span class="p">[</span><span class="err">\</span><span class="nx">W</span><span class="p">]</span> <span class="o">*=</span> <span class="err">\</span><span class="nx">s</span><span class="o">*</span> <span class="p">(</span><span class="err">\</span><span class="nx">w</span><span class="o">+</span><span class="p">.</span><span class="o">*?</span><span class="p">)</span> <span class="p">(</span><span class="err">\</span><span class="o">*</span><span class="err">\\</span><span class="o">/</span><span class="p">)</span><span class="o">?</span><span class="nx">$</span>
<span class="err">///gm</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>Utility functions</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">HoldingQueue</span>
  <span class="nv">constructor: </span><span class="nf">({@task, @onComplete}) -&gt;</span>
    <span class="vi">@holdKeys = </span><span class="p">[]</span>
  <span class="nv">waitFor: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@holdKeys</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span>
  <span class="nv">unwaitFor: </span><span class="nf">(key) -&gt;</span>
    <span class="vi">@holdKeys = </span><span class="nx">_</span><span class="p">.</span><span class="nx">without</span> <span class="nx">@holdKeys</span><span class="p">,</span> <span class="nx">key</span>
  <span class="nv">perform: </span><span class="nf">(key, args...) -&gt;</span>
    <span class="nx">@task</span> <span class="nx">args</span><span class="p">...,</span> <span class="o">=&gt;</span> <span class="nx">@unwaitFor</span> <span class="nx">key</span>
  <span class="nv">finalize: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@holdKeys</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nx">@onComplete</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nv">h = </span><span class="nx">setInterval</span> <span class="p">(</span><span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">@holdKeys</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nx">@onComplete</span><span class="p">()</span>
          <span class="nx">clearInterval</span> <span class="nx">h</span>
      <span class="p">),</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Extract directives from code using regex</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">parseDirectives = </span><span class="nf">(code) -&gt;</span>
  <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[\r\t ]+$/gm</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span>  <span class="c1"># fix for issue #2</span>
  <span class="k">return</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nv">match = </span><span class="nx">HEADER</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
  <span class="nv">header = </span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">while</span> <span class="nv">match = </span><span class="nx">DIRECTIVE</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">header</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Strip the extension from file. Extension with greatest number of components
first.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">stripExt = </span><span class="nf">(filePath) -&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">ext = </span><span class="nx">getExt</span> <span class="nx">filePath</span><span class="p">)</span>
    <span class="nv">extStart = </span><span class="nx">filePath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">ext</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">filePath</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">extStart</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="nx">filePath</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Returns the matching extension with greatest number of components,
or null if no supported extension found</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getExt = </span><span class="nf">(filePath) -&gt;</span>
  <span class="k">for</span> <span class="nx">ext</span> <span class="k">in</span> <span class="nx">jsExts</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">filePath</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ext</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">ext</span>
  <span class="k">return</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Returns list of acceptable file extensions ordered by number of
extension components within each extension
(i.e. <code>.js.coffee</code> before <code>.coffee</code>)
Default: <code>[ '.coffee', '.js' ]</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">jsExts = </span><span class="o">-&gt;</span>
  <span class="nv">exts = </span><span class="p">(</span><span class="nx">ext</span> <span class="k">for</span> <span class="nx">ext</span> <span class="k">of</span> <span class="nx">compilers</span><span class="p">).</span><span class="nx">concat</span> <span class="s1">&#39;js&#39;</span>
  <span class="nv">sortedExts = </span><span class="nx">_</span><span class="p">.</span><span class="nx">sortBy</span> <span class="nx">exts</span><span class="p">,</span> <span class="nf">(v) -&gt;</span> <span class="o">-</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">(</span><span class="s2">&quot;.#{ext}&quot;</span> <span class="k">for</span> <span class="nx">ext</span> <span class="k">in</span> <span class="nx">sortedExts</span><span class="p">)</span>

<span class="nv">minify = </span><span class="nf">(js) -&gt;</span>
  <span class="nv">jsp = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">parser</span>
  <span class="nv">pro = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">uglify</span>
  <span class="nv">ast = </span><span class="nx">jsp</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">js</span>
  <span class="nv">ast = </span><span class="nx">pro</span><span class="p">.</span><span class="nx">ast_mangle</span> <span class="nx">ast</span>
  <span class="nv">ast = </span><span class="nx">pro</span><span class="p">.</span><span class="nx">ast_squeeze</span> <span class="nx">ast</span>
  <span class="nx">pro</span><span class="p">.</span><span class="nx">gen_code</span> <span class="nx">ast</span>

<span class="nv">timeEq = </span><span class="nf">(date1, date2) -&gt;</span>
  <span class="nx">date1</span><span class="o">?</span> <span class="o">and</span> <span class="nx">date2</span><span class="o">?</span> <span class="o">and</span> <span class="nx">date1</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">is</span> <span class="nx">date2</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>

<span class="nv">module.exports.global = </span><span class="nx">global</span>

</pre></div>             </td>           </tr>                </tbody>     </table>     <!--          -->   </div> </body> </html>  